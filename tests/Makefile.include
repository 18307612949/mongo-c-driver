noinst_PROGRAMS += test-load
noinst_PROGRAMS += test-mock-server
noinst_PROGRAMS += test-mongoc-array
noinst_PROGRAMS += test-mongoc-buffer
noinst_PROGRAMS += test-mongoc-client
noinst_PROGRAMS += test-mongoc-client-pool
noinst_PROGRAMS += test-mongoc-collection
noinst_PROGRAMS += test-mongoc-list
noinst_PROGRAMS += test-mongoc-queue
noinst_PROGRAMS += test-mongoc-read-prefs
noinst_PROGRAMS += test-mongoc-rpc
noinst_PROGRAMS += test-mongoc-uri
noinst_PROGRAMS += test-mongoc-write-concern
noinst_PROGRAMS += test-secondary


TEST_PROGS =
TEST_PROGS += test-mongoc-array
TEST_PROGS += test-mongoc-buffer
TEST_PROGS += test-mongoc-client
TEST_PROGS += test-mongoc-client-pool
TEST_PROGS += test-mongoc-collection
TEST_PROGS += test-mongoc-list
TEST_PROGS += test-mongoc-queue
TEST_PROGS += test-mongoc-read-prefs
TEST_PROGS += test-mongoc-rpc
TEST_PROGS += test-mongoc-uri
TEST_PROGS += test-mongoc-write-concern


TEST_LIBS = libmongoc-1.0.la $(BSON_LIBS) $(SHM_LIB)


test_load_SOURCES = $(top_srcdir)/tests/test-load.c
test_load_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_load_LDADD = $(TEST_LIBS)


test_mock_server_SOURCES = $(top_srcdir)/tests/test-mock-server.c
test_mock_server_SOURCES += $(top_srcdir)/tests/mock-server.c
test_mock_server_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mock_server_LDADD = $(TEST_LIBS) -lpthread


test_mongoc_array_SOURCES = $(top_srcdir)/tests/test-mongoc-array.c
test_mongoc_array_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mongoc_array_LDADD = $(TEST_LIBS)


test_mongoc_buffer_SOURCES = $(top_srcdir)/tests/test-mongoc-buffer.c
test_mongoc_buffer_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mongoc_buffer_LDADD = $(TEST_LIBS)


test_mongoc_client_SOURCES = $(top_srcdir)/tests/test-mongoc-client.c
test_mongoc_client_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mongoc_client_LDADD = $(TEST_LIBS)


test_mongoc_client_pool_SOURCES = $(top_srcdir)/tests/test-mongoc-client-pool.c
test_mongoc_client_pool_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mongoc_client_pool_LDADD = $(TEST_LIBS)


test_mongoc_collection_SOURCES = $(top_srcdir)/tests/test-mongoc-collection.c
test_mongoc_collection_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mongoc_collection_LDADD = $(TEST_LIBS)


test_mongoc_list_SOURCES = $(top_srcdir)/tests/test-mongoc-list.c
test_mongoc_list_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mongoc_list_LDADD = $(TEST_LIBS)


test_mongoc_queue_SOURCES = $(top_srcdir)/tests/test-mongoc-queue.c
test_mongoc_queue_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mongoc_queue_LDADD = $(TEST_LIBS)


test_mongoc_read_prefs_SOURCES = $(top_srcdir)/tests/test-mongoc-read-prefs.c
test_mongoc_read_prefs_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mongoc_read_prefs_LDADD = $(TEST_LIBS)


test_mongoc_rpc_SOURCES = $(top_srcdir)/tests/test-mongoc-rpc.c
test_mongoc_rpc_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mongoc_rpc_LDADD = $(TEST_LIBS)


test_mongoc_uri_SOURCES = $(top_srcdir)/tests/test-mongoc-uri.c
test_mongoc_uri_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mongoc_uri_LDADD = $(TEST_LIBS)


test_mongoc_write_concern_SOURCES = $(top_srcdir)/tests/test-mongoc-write-concern.c
test_mongoc_write_concern_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_mongoc_write_concern_LDADD = $(TEST_LIBS)


test_secondary_SOURCES = $(top_srcdir)/tests/test-secondary.c
test_secondary_CPPFLAGS = -I$(top_srcdir)/mongoc $(BSON_CFLAGS)
test_secondary_LDADD = $(TEST_LIBS)


test: $(TEST_PROGS)
	@ echo "Checking if MongoDB is available on 27017."
	@ $(NETCAT) 127.0.0.1 27017 </dev/null
	@ for TEST_PROG in $(TEST_PROGS) ; do \
		./$$TEST_PROG ; \
	done
