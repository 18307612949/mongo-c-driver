

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>BSON &mdash; MongoDB C Driver 0.7 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="MongoDB C Driver 0.7 documentation" href="index.html" />
    <link rel="next" title="Connections" href="connections.html" />
    <link rel="prev" title="Building the MongoDB C Driver" href="building.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="connections.html" title="Connections"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="building.html" title="Building the MongoDB C Driver"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">MongoDB C Driver 0.7 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="bson">
<h1>BSON<a class="headerlink" href="#bson" title="Permalink to this headline">¶</a></h1>
<p>BSON (i.e., binary structured object notation) is the binary format used
by MongoDB to store data and express queries and commands. To work with
MongoDB is to trade in BSON objects. This document describes how to
create, read, and destroy BSON objects using the MongoDB C Driver.</p>
<div class="section" id="libraries">
<h2>Libraries<a class="headerlink" href="#libraries" title="Permalink to this headline">¶</a></h2>
<p>A brief note on libraries.</p>
<p>When you compile the driver, the BSON library is included in the
driver. This means that when you include <tt class="docutils literal"><span class="pre">mongo.h</span></tt>, you have access
to all the functions declared in <tt class="docutils literal"><span class="pre">bson.h</span></tt>.</p>
<p>If you want to use BSON independently, you don&#8217;t need <tt class="docutils literal"><span class="pre">libmongoc</span></tt>: when you compile
the driver, you&#8217;ll also get shared and static libraries for <tt class="docutils literal"><span class="pre">libbson</span></tt>. You
can link to this library and simple require <tt class="docutils literal"><span class="pre">bson.h</span></tt>.</p>
</div>
<div class="section" id="using-bson-objects">
<h2>Using BSON objects<a class="headerlink" href="#using-bson-objects" title="Permalink to this headline">¶</a></h2>
<p>The pattern of BSON object usage is pretty simple. Here are the steps:</p>
<ol class="arabic simple">
<li>Initiate a new BSON object.</li>
<li>Construct the object using the bson_append_* methods.</li>
<li>Pass the object to bson_finish() to finalize it. The object is now ready to use.</li>
<li>When you&#8217;re done with it, pass the object to bson_destroy() to free up any allocated
memory.</li>
</ol>
<p>To demonstrate, let&#8217;s create a BSON object corresponding to the simple JSON object
<tt class="docutils literal"><span class="pre">{count:</span> <span class="pre">1001}</span></tt>.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">bson</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="n">bson_init</span><span class="p">(</span> <span class="n">b</span> <span class="p">);</span>
<span class="n">bson_append_int</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="mi">1001</span> <span class="p">);</span>
<span class="n">bson_finish</span><span class="p">(</span> <span class="n">b</span> <span class="p">);</span>

<span class="cm">/* BSON object now ready for use */</span>

<span class="n">bson_destroy</span><span class="p">(</span> <span class="n">b</span> <span class="p">);</span>
</pre></div>
</div>
<p>That&#8217;s all there is to creating a basic object.</p>
<div class="section" id="creating-complex-bson-objects">
<h3>Creating complex BSON objects<a class="headerlink" href="#creating-complex-bson-objects" title="Permalink to this headline">¶</a></h3>
<p>BSON objects can contain arrays as well as sub-objects. Here
we&#8217;ll see how to create these by building the bson object
corresponding to the following JSON object:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Kyle&quot;</span><span class="p">,</span>

  <span class="nx">colors</span><span class="o">:</span> <span class="p">[</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span> <span class="p">],</span>

  <span class="nx">address</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">city</span><span class="o">:</span> <span class="s2">&quot;New York&quot;</span><span class="p">,</span>
    <span class="nx">zip</span><span class="o">:</span> <span class="s2">&quot;10011-4567&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span class="n">bson</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="n">bson_init</span><span class="p">(</span> <span class="n">b</span> <span class="p">);</span>
<span class="n">bson_append_string</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;Kyle&quot;</span> <span class="p">);</span>

<span class="n">bson_append_start_array</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;colors&quot;</span> <span class="p">);</span>
  <span class="n">bson_append_string</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="s">&quot;red&quot;</span> <span class="p">);</span>
  <span class="n">bson_append_string</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;blue&quot;</span> <span class="p">);</span>
  <span class="n">bson_append_string</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">,</span> <span class="s">&quot;green&quot;</span> <span class="p">);</span>
<span class="n">bson_append_finish_array</span><span class="p">(</span> <span class="n">b</span> <span class="p">);</span>

<span class="n">bson_append_start_object</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;address&quot;</span> <span class="p">);</span>
  <span class="n">bson_append_string</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;city&quot;</span><span class="p">,</span> <span class="s">&quot;New York&quot;</span> <span class="p">);</span>
  <span class="n">bson_append_string</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;zip&quot;</span><span class="p">,</span> <span class="s">&quot;10011-4567&quot;</span> <span class="p">);</span>
<span class="n">bson_append_finish_object</span><span class="p">(</span> <span class="n">b</span> <span class="p">);</span>

<span class="k">if</span><span class="p">(</span> <span class="n">bson_finish</span><span class="p">(</span> <span class="n">b</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">BSON_OK</span> <span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; Error. &quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Notice that for the array, we have to manually set the index values
from &#8220;0&#8221; to <em>n</em>, where <em>n</em> is the number of elements in the array.</p>
<p>You&#8217;ll notice that some knowledge of the BSON specification and
of the available types is necessary. For that, take a few minutes to
consult the <a class="reference external" href="http://bsonspec.org">official BSON specification</a>.</p>
</div>
</div>
<div class="section" id="error-handling">
<h2>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h2>
<p>The names of BSON object values, as well as all strings, must be
encoded as valid UTF-8. The BSON library will automatically check
the encoding of strings as you create BSON objects, and if the objects
are invalid, you&#8217;ll be able to check for this condition. All of the
bson_append_* methods will return either BSON_OK for BSON_ERROR. You
can check in your code for the BSON_ERROR condition and then see the
exact nature of the error by examining the bson-&gt;err field. This bitfield
can contain any of the following values:</p>
<ul class="simple">
<li>BSON_VALID</li>
<li>BSON_NOT_UTF8</li>
<li>BSON_FIELD_HAS_DOT</li>
<li>BSON_FIELD_INIT_DOLLAR</li>
<li>BSON_ALREADY_FINISHED</li>
</ul>
<p>The most important of these is <tt class="docutils literal"><span class="pre">BSON_NOT_UTF8</span></tt> because the BSON
objects cannot be used with MongoDB if they&#8217;re not valid UTF8.</p>
<p>To keep your code clean, you may want to check for BSON_OK only when
calling <tt class="docutils literal"><span class="pre">bson_finish()</span></tt>. If the object is not valid, it will not be
finished, so it&#8217;s quite important to check the return code here.</p>
</div>
<div class="section" id="reading-bson-objects">
<h2>Reading BSON objects<a class="headerlink" href="#reading-bson-objects" title="Permalink to this headline">¶</a></h2>
<p>You can read through a BSON object using a <tt class="docutils literal"><span class="pre">bson_iterator</span></tt>. For
a complete example, you may want to read through the implementation
of <tt class="docutils literal"><span class="pre">bson_print_raw()</span></tt> (in <tt class="docutils literal"><span class="pre">bson.h</span></tt>). But the basic idea is to
initialize a <tt class="docutils literal"><span class="pre">bson_iterator</span></tt> object and then iterate over each
successive element using <tt class="docutils literal"><span class="pre">bson_iterator_next()</span></tt>. Let&#8217;s take an
example. Suppose we have a finished object of type <tt class="docutils literal"><span class="pre">bson*</span></tt> called <tt class="docutils literal"><span class="pre">b</span></tt>:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">bson_iterator</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">bson_type</span> <span class="n">type</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>

<span class="n">bson_iterator_init</span><span class="p">(</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="p">);</span>

<span class="n">type</span> <span class="o">=</span> <span class="n">bson_iterator_next</span><span class="p">(</span> <span class="n">i</span> <span class="p">);</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">bson_iterator_key</span><span class="p">(</span> <span class="n">i</span> <span class="p">);</span>

<span class="n">printf</span><span class="p">(</span> <span class="s">&quot;Type: %d, Key: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">key</span> <span class="p">);</span>
</pre></div>
</div>
<p>We&#8217;ve advanced to the first element in the object, and we can print
both it&#8217;s BSON numeric type and its key name. To print the value,
we need to use the type to find the correct method for reading the
value. For instance, if the element is a string, then we use
<tt class="docutils literal"><span class="pre">bson_iterator_string</span></tt> to return the result:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">printf</span><span class="p">(</span> <span class="s">&quot;Value: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bson_iterator_string</span><span class="p">(</span> <span class="n">i</span> <span class="p">)</span> <span class="p">);</span>
</pre></div>
</div>
<p>In addition to iterating over each successive BSON element,
we can use the <tt class="docutils literal"><span class="pre">bson_find()</span></tt> function to jump directly
to an element by name. Again, suppose that <tt class="docutils literal"><span class="pre">b</span></tt> is a pointer
to a <tt class="docutils literal"><span class="pre">bson</span></tt> object. If we want to jump to the element
named &#8220;address&#8221;, we use <tt class="docutils literal"><span class="pre">bson_find()</span></tt> like so:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">bson_iterator</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="n">bson_type</span> <span class="n">type</span><span class="p">;</span>

<span class="n">type</span> <span class="o">=</span> <span class="n">bson_find</span><span class="p">(</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;address&quot;</span> <span class="p">);</span>
</pre></div>
</div>
<p>This will initialize the iterator, <tt class="docutils literal"><span class="pre">i</span></tt>, and position
it at the element named &#8220;address&#8221;. The return value
will be the &#8220;address&#8221; element&#8217;s type.</p>
</div>
<div class="section" id="reading-sub-objects-and-arrays">
<h2>Reading sub-objects and arrays<a class="headerlink" href="#reading-sub-objects-and-arrays" title="Permalink to this headline">¶</a></h2>
<p>Since &#8220;address&#8221; is a sub-object, we need to specially
iterate it. To do that, we get the raw value and initialize
a new BSON iterator like so:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">type</span> <span class="o">=</span> <span class="n">bson_find</span><span class="p">(</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;address&quot;</span> <span class="p">);</span>

<span class="n">bson_iterator_subiterator</span><span class="p">(</span> <span class="n">i</span><span class="p">,</span> <span class="n">sub</span> <span class="p">);</span>
</pre></div>
</div>
<p>The function <tt class="docutils literal"><span class="pre">bson_iterator_subiterator</span></tt> initializes
the iterator <tt class="docutils literal"><span class="pre">sub</span></tt> and points it to the beginning of the
sub-object. From there, we can iterate over
<tt class="docutils literal"><span class="pre">sub</span></tt> until we reach <tt class="docutils literal"><span class="pre">BSON_EOO</span></tt>, indicating the end of the
sub-object.</p>
<p>If you want to work with a sub-object by itself, there&#8217;s
a function, <tt class="docutils literal"><span class="pre">bson_iterator_subobject</span></tt>, for initializing
a new <tt class="docutils literal"><span class="pre">bson</span></tt> object with the value of the sub-object. Note
that this does not copy the object. If you want a copy of the
object, use <tt class="docutils literal"><span class="pre">bsop_copy()</span></tt>.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">bson</span> <span class="n">copy</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="n">bson_copy</span><span class="p">(</span> <span class="n">copy</span><span class="p">,</span> <span class="n">sub</span> <span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-a-raw-bson-pointer">
<h2>Getting a Raw BSON Pointer<a class="headerlink" href="#getting-a-raw-bson-pointer" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you&#8217;ll want to access the <tt class="docutils literal"><span class="pre">char</span> <span class="pre">*</span></tt> that
points to the buffer storing the raw BSON object. For that,
use the <tt class="docutils literal"><span class="pre">bson_data()</span></tt> function. You can use this in concert
with the bson_iterator_from_buffer() function to initialize an
iterator:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">bson_iterator</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="n">bson_iterator_from_buffer</span><span class="p">(</span> <span class="n">i</span><span class="p">,</span> <span class="n">bson_data</span><span class="p">(</span> <span class="n">b</span> <span class="p">)</span> <span class="p">);</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">BSON</a><ul>
<li><a class="reference internal" href="#libraries">Libraries</a></li>
<li><a class="reference internal" href="#using-bson-objects">Using BSON objects</a><ul>
<li><a class="reference internal" href="#creating-complex-bson-objects">Creating complex BSON objects</a></li>
</ul>
</li>
<li><a class="reference internal" href="#error-handling">Error handling</a></li>
<li><a class="reference internal" href="#reading-bson-objects">Reading BSON objects</a></li>
<li><a class="reference internal" href="#reading-sub-objects-and-arrays">Reading sub-objects and arrays</a></li>
<li><a class="reference internal" href="#getting-a-raw-bson-pointer">Getting a Raw BSON Pointer</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="building.html"
                        title="previous chapter">Building the MongoDB C Driver</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="connections.html"
                        title="next chapter">Connections</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/bson.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="connections.html" title="Connections"
             >next</a> |</li>
        <li class="right" >
          <a href="building.html" title="Building the MongoDB C Driver"
             >previous</a> |</li>
        <li><a href="index.html">MongoDB C Driver 0.7 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, 10gen.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>